#!/bin/bash
install_node() {
  local version="${1-0.10.24}"
  local platform="$(uname | tr A-Z a-z)"
  local cpu=x64
  if [[ "$(uname -p)" = "i686" ]]; then
    cpu=x86
  fi
  local archive="node-v${version}-${platform}-${cpu}.tar.gz"
  curl --silent \
    "http://nodejs.org/dist/v${version}/${archive}" \
    | tar --strip-components=1 --extract --gzip --file -
}

#sigh. http://mywiki.wooledge.org/BashFAQ/028
wallah_bin="$(dirname $0)"
node_root="$1"
if [[ -z "${node_root}" ]]; then
  node_root="${wallah_bin}/../../node"
fi
shift

if [[ -x "${node_root}/bin/node" ]]; then
  #all good
  exit 0
fi

if ! "${wallah_bin}/check_prerequisites" curl tar; then
  exit 2
fi
mkdir -p "${node_root}"
cd "${node_root}"
echo "node.js not installed in directory $(pwd -P), installing..."
install_node "$@"
